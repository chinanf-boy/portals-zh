
# 详细的设计讨论

## 隐私考虑

要求: 对于源和目标网站拥有不同所有者的用例,源网站的所有者可以保护其用户的隐私,这一点很重要. 

我们区分以下隐私问题: 

-   由于网络活动导致敏感个人数据泄露
-   由JS活动导致的敏感个人数据泄露
-   阻止第三方cookie的浏览器用户的注意事项
-   具有"双键"策略的浏览器用户对存储和缓存的注意事项
-   遵守GDPR

另一方面,我们认为以下情况属于隐私模型的范围: 

-   第一方和第三方之间的共谋,即第一方使第三方能够将隐私敏感数据汇集出去. 

### 非详尽的具体问题清单

网络活动导致的敏感个人数据泄露: 

-   揭示起源: *尴尬的关键字*.example.com的,*GUID-123ab54c-b49f-4e15-848e-212a42b4dfa8*.example.com的
-   揭示网址: [https://www.example.com/articles/*放,信用卡债务快速*html的](https://www.example.com/articles/*pay-off-credit-card-debt-fast*.html)
-   饼干
-   使用唯一的Etag验证以前缓存的资源
-   Beacon,ping也可以定期获取资源

JS活动导致敏感个人数据泄露: 

-   HTTP缓存填充: 
    1.  让每个页面获取一个长期存在的独特资源,
    2.  在后续导航中,使用资源计时的transferSize来测试每个唯一资源上的缓存命中,以构建/扩充用户模型. 
-   通过存储API跟踪: 
    1.  记录隐私敏感信息,例如从显示为插入的页面推断出的潜在兴趣,进入其中一个网络平台存储设施,
    2.  在后续导航中,上游数据用于扩充用户模型. 
-   通过范围SW跟踪: 
    1.  在特定的子路径下为每个页面提供服务并注册一个范围狭窄的SW,
    2.  在后续导航中,调用SW的getRegistrations以获取源的所有已注册SW的数组,上游信息以扩充用户模型. 

第三方Cookie阻止: 

-   门户网站不应该提供阻止第三方cookie阻止的能力. 

存储"双键"策略: 

-   在具有双密钥策略的浏览器中,数据在 (第一方源,第三方源) 的基础上进行分区. 数据集`someservice.com`在导航到由主持的页面的上下文中`example.com`在不同的环境中无法访问,例如导航到`someservice.com`也不是通过导航来`otherexample.com`碰巧还包括来自的脚本`someservice.com`. 
-   门户不应该提供破坏双密钥存储的这种属性的能力,即第三方不应该以自我促销其分区数据到第一方状态的方式使用门户. 

[GDPR](https://www.eugdpr.org/)合规性: 

-   从2018年5月25日起,欧盟将实施一项名为通用数据保护法规 (GDPR) 的新数据隐私法规,该法规取代了数据保护指令95/46 / EC. 
-   看来,关键区别之一是强调获得处理敏感个人数据的"明确"和"明确"同意. 

### 提案

#### 约束

1.  如果尚未激活的门户网站是以下内容,则无法保留隐私: 

-   从发布者或不受信任方拥有的服务器加载,或
-   能够访问发布者或不受信任方拥有的服务器,或
-   能够与发布者或不受信任的第三方拥有的非隔离服务工作者交谈. 

2.  如果尚未激活的门户能够以可由后续但不相关的导航检索的方式影响本地状态,则无法保留隐私. 

##### 约束#1

我们可以通过为具有隐私意识的开发人员提供限制网络活动的方法来解决第一个限制,这些方法可以将网络活动限制在他们信任的服实际上,这意味着服务器要么由源网站本身控制,要么由值得信赖的一方操作,例如,一个受法律约束的CDN合作伙伴. 

具体来说: 

-   受信任的实体必须能够提供完整的Portal感知页面. [网络包](https://github.com/WICG/webpackage/blob/master/explainer.md),即一捆[签署交流](https://tools.ietf.org/id/draft-yasskin-http-origin-signed-responses-02.html),会启用此功能. 
-   向浏览器传达将网络活动限制为隐私安全实体的愿望: 服务 (可信) 来源,本地HTTP缓存中的新资产,源来源. 使用自包含提示提供的Web包将实现此功能. 

##### 约束#2

对于第二个约束,我们可以通过提供两种模式来帮助注重隐私的开发人员: 

-   **受限制的模式. **拒绝尚未激活的门户任何可能导致影响本地状态的功能. 
-   **隔离模式. **允许尚未激活的门户网站修改本地状态,但保证不相关的导航无法访问所述状态. 

具体来说: 

-   **受限制的模式. **在任何尝试运行JS时禁止Javascript / fail. 可能的例外: 源通过CSP信任的脚本,例如: "script-src cdn.sourceproduct.org"激活后,会发出生命周期事件,再次允许Javascript,并且页面在其规范来源下运行. 
-   **隔离模式. **为尚未激活的Portal提供唯一的源,允许它运行Javascript并修改本地状态. 激活后,页面将继续在其唯一来源下运行,或者以其规范来源重新加载,但代价是失去对先前设置的本地状态的访问权. 目标页面的所有者有一种方法可以指定他们喜欢哪些行为. 
-   **孤立的服务工作者模式**提供了Service Worker及其importScripts,以及它们希望获取的内容 () 和要加载的URL. 如果URL已经有较新的SW注册,则使用该注册;否则,安装和使用提供的SW. 任何其他fetch () 都会失败,所有写入存储都会失败.  (从存储中读取可能是安全的吗?) 当门户被激活时,SW被杀死并重新启动而没有这些限制. 由于SW注册拥有客户,因此客户突然获得一个与其无关的SW也没有问题. 如果同一来源的并发客户端存在现有SW,则预激活的SW并行运行但不会影响"真实",并且后激活门户客户端重新使用"真实"SW.  (H / T @wycats) 

最后,对于不存在隐私问题的情况,例如,由同一所有者或可信方拥有的同源/起源,可以是不受限制的模式. 

UA应该**提供**合理的默认值,例如交叉起源时受到限制. 但是,UA**永远不要强迫**特定模式,因为从UA角度来看,实体和开发者意图之间的关系很难推理. 

### 第三方cookie阻止

如果用户已表示希望阻止第三方cookie,则浏览器应阻止a`<portal>`可以访问cookie /存储,但它仍然是一个门户网站,就像阻止任何第三方一样. 如果门户网站得到提升,例如通过导航,它可以访问其现有的cookie /存储 (如果有的话) . 

### 存储的双键策略

这只与...有关**隔离模式**以来**受限制的模式**会禁止任何有问题的存储访问. 的属性**隔离模式**足以维持存储的"双键"策略. 

让我们来看一个涉及隐私恶意页面的场景. 

设置: 1. 用户所在页面上的门户网站使用隔离模式指向隐私恶意页面. `<portal>`虽然还是一个*,敌对页面可以访问存储但在a独特的起源* (注意: 这是一个Chrome概念,但Firefox的不透明的独特来源似乎相关) ,这不是一个真正的起源. 

恶意页面有2个选项可供预先选择,以便定义激活其门户时会发生什么: 

-   继续在下运作*独特的起源*
-   重装我的*规范起源*以失去对我之前设置的本地状态的访问为代价. 

如果敌对页面选择了"继续操作下的*独特的起源*",然后它无法访问也不能将数据合并到规范原始存储中. 

如果敌对页面选择"重新加载我的*规范起源*",然后在. 下创建的数据*独特的起源*丢失,无法合并到规范原始存储中. 

## 生命周期事件

要求: 

-   尚未激活的Portal应该注意为其创建的页面的用户体验. 
-   在Restricted模式下运行的Portal在激活时需要一个事件来引导其逻辑,该逻辑到目前为止一直被禁止. 

这可以通过提供新的生命周期事件来解决: 

-   门户上下文创建
-   与文档中的DOM门户关联的门户上下文
-   门户上下文已激活和停用

备选方案: 考虑重新使用现有事件. 

## 激活时: 不做任何事/在我的起源下重装我

这仅在激活在隔离模式下运行的Portal时才有意义. 必须在激活发生之前指定所需的行为: 

-   默认值: 什么都不做
-   JS API设置所需的行为,即什么都不做/重新加载我的原始. 

### 在一个人的起源下重新加载

-   为了避免刺激用户体验,重新加载应该重新使用Web包中容易获得的资源 (假设: 这不能被污染) ,但除此之外什么也没有. 应该清除内存缓存. 

## 导航尚未激活的门户网站

-   尚未允许尚未激活的门户网站自行导航,例如,这会破坏各种假设,特别是隐私保护. 
-   这也意味着门户网站不必处理历史问题. 

# 打开问题

## 停用自己

-   激活的Portal是否能够自行停用?可能是. 
-   然后,Portal会保留其真实的起源和状态吗?可能是. 
-   非活动门户是否应该接收输入事件?不允许与非活动门户进行交互会产生额外的复杂性. 历史上的棘手

## 激活的Portal返回未激活状态的历史记录会发生什么变化?

-   是否会再次被禁止导航?
-   尚未激活的门户和可视性

## 默认情况下,iframe不会考虑可见度. 

这导致了各种干预措施,例如: 限制requestAnimationFrame或用于屏幕外交叉原点iframe的计时器. 我们是否可以利用这个新机会避免重复同样的错误,即默认情况下让Portals注意到Viewability?

可见度,可见性和门户

## iframe具有与主文档相同的可见性. 

尚未激活的门户网站也应如此吗?我们不能走得更远

## 似乎希望避免门户网站的递归,因为它可能会导致不明确的值 (用例?) 增加复杂性. 

选项: 

-   不应该允许尚未激活的门户创建任何Portal
-   不应该允许自己的门户. 

## 自包含但不完整的Web包

如果支持门户的Web包缺少某些资源,会发生什么?

-   加载完全失败?这会使事情变得更简单. 
-   提供反馈到源页面?怎么样?

## 门户网站破坏

与iframe和门户网站有相似之处. 某些发布商可能不希望在某些来源上拥有其内容的门户. 

-   我们是否需要一种与现有机制不同的机制,即重用x-frame-options?

## 服务工作者和限制模式

受限模式如何与服务工作者交互?

-   门户网站是否永远与其SW分离?
-   SW是否收到通知并有机会重新加载页面?
-   实际上依赖SW来组合其内容的页面怎么样?

## 门户网站所需的视觉行为

门户网站有多种用例可能需要不同的视觉行为: 

-   DOM门户可以显示门户上下文的部分视图,例如,假设完整视口呈现门户上下文,但DOM门户是半高视口,并且可能仅显示门户上下文的上半部分. 
-   DOM门户网站表现为门户网站上下文的"纹理贴图",即调整绘图大小以适应门户网站
-   DOM门户表现为布局上下文. 出于易读性原因,这很有用. 当门户网站扩展为覆盖整个视口作为导航过渡的一部分时,门户网站上下文的文档将根据为常规响应式设计设置的规则调整其布局. 

## 遵守GDPR的注意事项

来自Legal的反馈意见: 好像. 

细节: 

-   建议的API将允许发布者在激活时寻求用户同意 (例如,如果尚未获得,则使用相关事件来触发用户同意流1[ ]嵌入器可以以这样的方式约束嵌入的内容,即在激活之前保护用户的隐私. 
-   这允许发布者在尚未激活的流程中显示有用的东西 (与用户同意流程相反) . 1

[ 这可能意味着大多数内容所有者都希望在激活时选择在我的原点下重新加载我 ]否则,由于不透明的原始上下文,他们必须始终寻求用户同意. 可能有更好的选择. 
